<div class="container compendium-drop-target">

<input type="hidden" name="attr_sheet_version" value="110">
<input type="hidden" name="attr_populate_moves" value="all">
<input type="hidden" name="attr_rolltype" value="2d6">
<input type="hidden" name="attr_statmod_query" value="?{Stat|LIGHT,@{light_mod}[light]|DARK, @{dark_mod}[dark]|MASTERY, @{mastery_mod}[mastery]|HEART, @{heart_mod}[heart]}">
<input type="hidden" name="attr_levels_prepared" value="0">
<input type="hidden" name="attr_global_dmg" value="0">
<input type="hidden" name="attr_global_arm" value="0">
<input type="hidden" name="attr_global_ongoing" value="0">
<input type="hidden" name="attr_equipment_dmg" value="0">
<input type="hidden" name="attr_equipment_armor" value="0">
<input type="hidden" name="attr_equipment_armormod" value="0">
<input type="hidden" name="attr_equipment_totalarmor" value="0">
<input type="hidden" name="attr_heart_links" value="0">
<input type="hidden" name="attr_light_links" value="0">
<input type="hidden" name="attr_dark_links" value="0">
<input type="hidden" name="attr_mastery_links" value="0">
<input type="hidden" name="attr_bond_query" value="(0)[Other Bond]">
<input type="hidden" name="attr_link_query" value="?{Bonds|0}">

<!-- 
<input type="hidden" name="attr_level0_name" value="@{rotename}">
<input type="hidden" name="attr_rotename" value="Rote" data-i18n="rote">
<input type="hidden" name="attr_cantripname" value="Cantrip" data-i18n="cantrip">
 -->

<!-- For Generating translation keys only used dynamically, mostly in rolltemplates -->
<span class="invisible" tabindex="-1" data-i18n="armor">Armor</span>
<span class="invisible" tabindex="-1" data-i18n="look">Look</span>
<span class="invisible" tabindex="-1" data-i18n="hitpoints">Hit Points</span>
<span class="invisible" tabindex="-1" data-i18n="classdamage">Class Damage</span>
<span class="invisible" tabindex="-1" data-i18n="rote">Rote</span>
<span class="invisible" tabindex="-1" data-i18n="cantrip">Cantrip</span>



<input type="checkbox" class="invisible is-npc" tabindex="-1" name="attr_calc_isNPC" value="1" />

<div class="npc-toggler">
	<input type="checkbox" class="invisible is-npc-label-sib" name="attr_calc_isNPC" value="1" />
	<label>
		<input type="checkbox" value="1" class="npc-toggler-checkbox" name="attr_isNPC" />
	</label>
</div>

<div class="npc-container compendium-drop-target Monsters">
	<div class="npc-header">
		<span class="flex-row">
			<span><input type="text" class="npc-name" name="attr_character_name"></span>
			<span><span data-i18n="tags:" accept="Tags">Tags: </span>
			<input type="text" class="npc-tags" data-i18n-placeholder="tags" placeholder="Tags" name="attr_NPC_tags" accept="Tags"></span>
		</span>
		<span class="flex-row">
			<span>
				<input type="text" class="npc-attack-name" data-i18n-placeholder="attack-name" placeholder="Attack Name" name="attr_NPC_attack_name" accept="Attack Name">
				<input type="text" class="npc-attack-roll" data-i18n-placeholder="1d8+2" placeholder="1d8+2" name="attr_NPC_attack_roll" accept="Attack Roll">
				<button type="roll" name="roll_NPC_attack" value="&{template:dwgeneral} {{charname=@{character_name}}} {{rollname=@{NPC_attack_name}}} {{result=[[@{NPC_attack_roll}]]}}">damage</button>
				<input type="text" class="npc-attack-extrainfo" data-i18n-placeholder="zero-piercing" placeholder="0 piercing" name="attr_NPC_attack_extrainfo" accept="Attack Details">
			</span>
			<span>
				<input type="number" class="npc-hp" name="attr_HP" accept="HP"> / <input type="number" class="npc-hp" name="attr_HP_max" accept="HP">&nbsp;<span data-i18n="hp-u">HP</span>
				<input type="number" class="npc-armor" name="attr_NPC_armor" accept="Armor">&nbsp;<span data-i18n="armor">Armor</span>
			</span>
		</span>
		<span class="flex-row flex-left">
			<input type="text" class="npc-tags" data-i18n-placeholder="attack-reach" placeholder="Attack Reach(es)" name="attr_NPC_weapontags" accept="Weapon Tags">
		</span>
		<span class="flex-row flex-left">
			<span data-i18n="special-qualities:"><em>Special Qualities:</em></span>&nbsp;
			<input type="text" class="npc-qualities" name="attr_NPC_qualities" accept="Special Qualities">
		</span>
	</div>
	<div class="npc-main">
		<div>
			<textarea class="npc-description" name="attr_NPC_description" accept="Description"></textarea>
		</div>
		<div class="npc-extras">
			<span data-i18n="instinct:"><em>Instinct: </em></span>&nbsp;
			<input type="text" class="npc-instinct" name="attr_NPC_instinct" accept="Instinct">
			<br />
			<span data-i18n="moves" class="label">Moves</span>
			<input type="hidden" name="attr_comp_NPC_moves" accept="data-Moves">
			<fieldset class="repeating_NPCmoves">
				<div class="npc-moves">
					&bull; <input type="text" class="npc-move" name="attr_NPC_move" />
				</div>
			</fieldset>
		</div>
	</div>
</div>
<div class="top-container">
	<div class="gamebanner">
		<img src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/Dungeon%20World%20by%20Roll20/images/dw-logo-fg.png" alt="Dungeon World">
	</div>
	<div class="rows-container">
		<div class="header-container">
			<div class="name-container">
				<span class="label" data-i18n="char-name-u">NAME</span>
				<input type="text" name="attr_character_name">
			</div>
			<div class="progression-container">
				<div class="level-container">
					<span class="label" data-i18n="level-u">LEVEL</span>
					<input type="number" name="attr_level" value="1">
				</div>
				<div class="xp-container">
					<span class="label" data-i18n="xp-u">XP</span>
					<input type="number" name="attr_xp" value="0">
				</div>
			</div>
		</div>

		<div class="class-container">
			<span class="label" data-i18n="char-class-u">PLAYBOOK</span>
			<input type="hidden" name="attr_comp_name">
			<input type="hidden" name="attr_comp_damagedie">
			<input type="hidden" name="attr_comp_classmoves">
			<input type="hidden" name="attr_comp_load">
			<input type="text" name="attr_character_class">
		</div>
	</div>
</div>
<div class="navigation-container">
	<div class="nav-tabs">
		<div class="toggler">
			<label>
				<input type="radio" class="pagebutton-main" name="attr_page" value="0" checked="checked"><span data-i18n="main">Main</span>
			</label>
			<label>
				<input type="radio" class="pagebutton-sub" name="attr_page" value="1"><span data-i18n="sub">Sub</span>
			</label>
			<label>
				<input type="radio" class="pagebutton-settings" name="attr_page" value="2"><span data-i18n="settings">Settings</span>
			</label>
		</div>
	</div>
	<div class="roll-mods hold-box">
		<div class="toggler">
			<label>
				<input type="radio" class="roll-normal" name="attr_rollforward" value="0" checked="checked"><span data-i18n="normal">Normal</span>
			</label>
			<label>
				<input type="radio" class="roll-plusone" name="attr_rollforward" value="1"><span data-i18n="plus-one-forward">+1 Forward</span>
			</label>
			<label>
				<input type="radio" class="roll-minusone" name="attr_rollforward" value="-1"><span data-i18n="minus-one-forward">-1 Forward</span>
			</label>
			<label>
				<input type="radio" class="roll-query" name="attr_rollforward" value="?{Modifier|0}"><span data-i18n="query">Query</span>
			</label>
			<label>
				<input type="radio" class="roll-query" name="attr_rollforward" value="@{hold}"><span data-i18n="hold:">Hold:</span>
			</label>
			<input type="number" name="attr_hold" value="0" />
		</div>
	</div>
</div>
<input type="radio" class="hpage-main invisible" tabindex="-1" name="attr_calc_page" value="0" checked="checked">
<input type="radio" class="hpage-sub invisible" tabindex="-1" name="attr_calc_page" value="1">
<input type="radio" class="hpage-settings invisible" tabindex="-1" name="attr_calc_page" value="2">

<div class="page main-page">

<div class="mid-container">
	<div class="mid-module look-container">
		<div class="mid-header">
			<button type="roll" name="roll_showlook" value="&{template:dwgeneral} {{charname=@{character_name}}} {{infoname=^{look}}} {{details=@{char_look}}}">
			<span class="label" data-i18n="look-u">LOOK</span>
			</button>
		</div>
		<div class="mid-content look">
			<textarea name="attr_char_look"></textarea>
		</div>
	</div>
	<div class="mid-module vitals-container">
		<div class="vital mid-header armor-container">
			<button type="roll" name="roll_showarmor" value="&{template:dwgeneral} {{charname=@{character_name}}} {{infoname=^{armor}}} {{details=[[@{armor}]]}}">
			<span class="label" data-i18n="armor-u">ARMOR</span>
			</button>
			<input type="number" name="attr_armor" value="@{equipment_armor}+@{equipment_armormod}+@{global_arm}" disabled="true">
		</div>
		<div class="vital mid-header hp-container">
			<button type="roll" name="roll_showhp" value="&{template:dwgeneral} {{charname=@{character_name}}} {{infoname=^{hitpoints}}} {{details=[[@{HP}]]&#47;[[@{HP|max}]]}}">
			<span class="label" data-i18n="hitpoints-u">HIT POINTS</span>
			</button>
			<span class="heart"></span>
			<input type="number" min="0" class="hitpoints" name="attr_HP" value="0">
			<input type="number" min="0" class="max-hitpoints" name="attr_HP_max" value="0">
		</div>
<!-- 		<div class="vital mid-header damage-container">
			<button type="roll" name="roll_damage" value="&{template:dwgeneral} {{charname=@{character_name}}} {{rollname=^{classdamage}}} {{result=[[@{damagedie} + @{equipment_dmg} + @{global_dmg}]]}}">
			<span class="label" data-i18n="damage-u">DAMAGE</span>
			</button>
			<select name="attr_damagedie">
				<option value="d4" selected="selected">d4</option>
				<option value="d6">d6</option>
				<option value="d8">d8</option>
				<option value="d10">d10</option>
				<option value="d12">d12</option>
				<option value="d20">d20</option>
			</select>
		</div> -->
	</div>
<!-- 	<div class="mid-module alignment-container">
		<div class="mid-header">
			<span class="label" data-i18n="alignment-u">ALIGNMENT</span>
		</div>
		<div class="mid-content alignment">
			<input type="text" name="attr_alignment">
			<textarea name="attr_alignment_details"></textarea>
		</div>

	</div> -->

</div>
<div class="sheet-mid-stat-container">
	<div class="stats-container">
		<div class="dw stats">
			<div class="dw-statbox">
				<div class="dw-stat-header">
					<span class="dw-statname-long" data-i18n="light">Strength</span>
					<input type="number" name="attr_light" value="0">
				</div>
				<div class="dw-stat-debility">
						<label><span class="dw-debility-name" data-i18n="weak-1">Weak -1</span>
						<input type="checkbox" name="attr_debil_weak" value="1"></label>
					</div>
				<div class="dw-stat-footer">
					<div class="dw-stat-circle">
					<button type="roll" name="roll_light" value="&{template:dwgeneral} {{charname=@{character_name}}} {{rollname=Strength}} {{result=[[@{rolltype} + @{light_mod} + (@{rollforward})[forward] + @{global_ongoing}[global ongoing]]]}}">
						<br />
						<span class="dw-statname-short" data-i18n="light-u">LIGHT</span>
						<br />
						<input type="hidden" name="attr_calc_light_mod" value="0" />
						<input type="number" class="dw-statbonus" name="attr_light_mod" value="@{calc_light_mod}" disabled="true">
					</button>
					</div>
					<div class="dw-links">
						<textarea name="attr_light_links"></textarea>
					</div>
				</div>
			</div>
			<div class="dw-statbox">
				<div class="dw-stat-header">
					<span class="dw-statname-long" data-i18n="dark">Dexterity</span>
					<input type="number" name="attr_dark" value="0">
				</div>
				<div class="dw-stat-debility">
						<label><span class="dw-debility-name" data-i18n="shaky-1">Shaky -1</span>
						<input type="checkbox" name="attr_debil_shaky" value="1"></label>
					</div>
				<div class="dw-stat-footer">
					<div class="dw-stat-circle">
					<button type="roll" name="roll_dark" value="&{template:dwgeneral} {{charname=@{character_name}}} {{rollname=Dexterity}} {{result=[[@{rolltype} + @{dark_mod} + (@{rollforward})[forward] + @{global_ongoing}[global ongoing]]]}}">
						<br />
						<span class="dw-statname-short" data-i18n="dark-u">DARK</span>
						<br />
						<input type="hidden" name="attr_calc_dark_mod" value="0" />
						<input type="number" class="dw-statbonus" name="attr_dark_mod" value="@{calc_dark_mod}" disabled="true">
					</button>
					</div>
					<div class="dw-links">
						<textarea name="attr_dark_links"></textarea>
					</div>
				</div>
			</div>
			<div class="dw-statbox">
				<div class="dw-stat-header">
					<span class="dw-statname-long" data-i18n="mastery">Constitution</span>
					<input type="number" name="attr_mastery" value="0">
				</div>
				<div class="dw-stat-debility">
						<label><span class="dw-debility-name" data-i18n="sick-1">Sick -1</span>
						<input type="checkbox" name="attr_debil_sick" value="1"></label>
					</div>
				<div class="dw-stat-footer">
					<div class="dw-stat-circle">
					<button type="roll" name="roll_mastery" value="&{template:dwgeneral} {{charname=@{character_name}}} {{rollname=Constitution}} {{result=[[@{rolltype} + @{mastery_mod} + (@{rollforward})[forward] + @{global_ongoing}[global ongoing]]]}}">
						<br />
						<span class="dw-statname-short" data-i18n="mastery-u">MASTER</span>
						<br />
						<input type="hidden" name="attr_calc_mastery_mod" value="0" />
						<input type="number" class="dw-statbonus" name="attr_mastery_mod" value="@{calc_mastery_mod}" disabled="true">
					</button>
					</div>
					<div class="dw-links">
						<textarea name="attr_mastery_links"></textarea>
					</div>
				</div>
			</div>
			<div class="dw-statbox">
				<div class="dw-stat-header">
					<span class="dw-statname-long" data-i18n="heart">Intelligence</span>
					<input type="number" name="attr_heart" value="0">
				</div>
				<div class="dw-stat-debility">
						<label><span class="dw-debility-name" data-i18n="stunned-1">Stunned -1</span>
						<input type="checkbox" name="attr_debil_stunned" value="1"></label>
					</div>
				<div class="dw-stat-footer">
					<div class="dw-stat-circle">
					<button type="roll" name="roll_heart" value="&{template:dwgeneral} {{charname=@{character_name}}}{{rollname=Intelligence}} {{result=[[@{rolltype} + @{heart_mod} + (@{rollforward})[forward] + @{global_ongoing}[global ongoing]]]}}">
						<br />
						<span class="dw-statname-short" data-i18n="heart-u">HEART</span>
						<br />
						<input type="hidden" name="attr_calc_heart_mod" value="0" />
						<input type="number" class="dw-statbonus" name="attr_heart_mod" value="@{calc_heart_mod}" disabled="true">
					</button>

					</div>
					<div class="dw-links">
						<textarea name="attr_heart_links"></textarea>
					</div>
				</div>
			</div>
			<!-- <div class="dw-statbox">
				<div class="dw-stat-header">
					<span class="dw-statname-long" data-i18n="wisdom">Wisdom</span>
					<input type="number" name="attr_wisdom" value="10">
				</div>
				<div class="dw-stat-debility">
						<label><span class="dw-debility-name" data-i18n="confused-1">Confused -1</span>
						<input type="checkbox" name="attr_debil_confused" value="1"></label>
					</div>
				<div class="dw-stat-footer">
					<div class="dw-stat-circle">
					<button type="roll" name="roll_wisdom" value="&{template:dwgeneral} {{charname=@{character_name}}} {{rollname=Wisdom}} {{result=[[@{rolltype} + @{wisdom_mod} + (@{rollforward})[forward] + @{global_ongoing}[global ongoing]]]}}">
						<br />
						<span class="dw-statname-short" data-i18n="wis-u">WIS</span>
						<br />
						<input type="hidden" name="attr_calc_wisdom_mod" value="0" />
						<input type="number" class="dw-statbonus" name="attr_wisdom_mod" value="@{calc_wisdom_mod}" disabled="true">
					</button>
					</div>
				</div>
			</div>
			<div class="dw-statbox">
				<div class="dw-stat-header">
					<span class="dw-statname-long" data-i18n="charisma">Charisma</span>
					<input type="number" name="attr_charisma" value="10">
				</div>
				<div class="dw-stat-debility">
						<label><span class="dw-debility-name" data-i18n="scarred-1">Scarred -1</span>
						<input type="checkbox" name="attr_debil_scarred" value="1"></label>
					</div>
				<div class="dw-stat-footer">
					<div class="dw-stat-circle">
					<button type="roll" name="roll_charisma" value="&{template:dwgeneral} {{charname=@{character_name}}} {{rollname=Charisma}} {{result=[[@{rolltype} + @{charisma_mod} + (@{rollforward})[forward] + @{global_ongoing}[global ongoing]]]}}">
						<br />
						<span class="dw-statname-short" data-i18n="cha-u">CHA</span>
						<br />
						<input type="hidden" name="attr_calc_charisma_mod" value="0" />
						<input type="number" class="dw-statbonus" name="attr_charisma_mod" value="@{calc_charisma_mod}" disabled="true">
					</button>
					</div>
				</div>
			</div> -->

		</div>

	</div>
	
<!-- <div class="sheet-mid-container">
	<div class="stats-container">
		<div class="dw stats">

					<div class="dw-heart-links">
						<textarea name="attr_heart_links"></textarea>
					</div>

			<div class="dw-statbox">
					<div class="dw-heart-links">
						<textarea name="attr_heart_links"></textarea>
					</div>
			</div>
			<div class="dw-statbox">
					<div class="dw-heart-links">
						<textarea name="attr_heart_links"></textarea>
					</div>
			</div>
			<div class="dw-statbox">
					<div class="dw-heart-links">
						<textarea name="attr_heart_links"></textarea>
					</div>
			</div>
			</div>
		</div>
	</div> -->
</div>
<!-- 
	<div class="misc-container">
		<div class="mid-header">
			<span class="label" data-i18n="bonds-u">BONDS</span>
		</div>
		<div class="mid-content bonds">
			<fieldset class="repeating_bonds">
				<div class="bonds-main">
					<input type="text" name="attr_bond_simple" />
					<input class="expander expand-bond" type="checkbox" name="attr_expand_bond" value="1" title="Expand for additional notes" checked="checked" />
					<span> </span>
					<div class="bond-expansion">
						<textarea name="attr_bond_details"></textarea>
					</div>
				</div>
			</fieldset>
		</div>
		<div class="mid-header">
			<span class="label" data-i18n="race-u">RACE</span>
		</div>
		<div class="mid-content race">
			<div class="race-main">
				<input type="text" name="attr_race" />
                <textarea name="attr_race_details" style="height:50px;"></textarea>
			</div>
		</div>
		<div class="mid-header">
			<span class="label" data-i18n="global-modifiers-u">GLOBAL MODIFIERS</span>
		</div>
		<div class="mid-content gmod">
			<fieldset class="repeating_gmods">
				<div class="global-mods-main">
					<input class="enable-mod" type="checkbox" name="attr_enable_modifier" value="1">
					<input type="text" name="attr_gmod_name" />
					<input class="expander expand-gmod" type="checkbox" name="attr_expand_gmod" value="1" checked="checked" />
					<span> </span>
					<div class="gmod-expansion">
						<div class="flex-row flex-left">
							<input class="enable-mod" type="checkbox" name="attr_ongoing_on" value="1" />
							<span>
								<span class="label" data-i18n="ongoing-roll-mod:">Ongoing Roll Modifier: </span>
								<input type="number" name="attr_gmod_ongoing_mod" value="0" />
							</span>
						</div>
                          <div class="flex-row flex-left">
							<input class="enable-mod" type="checkbox" name="attr_barbdice_on" value="1" />
							<span>
								<span class="label" data-i18n="roll1d61d8formoves">Roll 1d6+1d8 for Moves </span>
							</span>
						</div>
						<div class="flex-row flex-left">
							<input class="enable-mod" type="checkbox" name="attr_dmg_on" value="1" />
							<span>
								<span class="label" data-i18n="damage-mod:">Damage Mod:</span>
								<input type="number" name="attr_gmod_dmg_diecount" value="0" />
								<select class="gmod-die" name="attr_gmod_dmg_die">
									<option value="d0" selected="selected">--</option>
									<option value="d4">d4</option>
									<option value="d6">d6</option>
									<option value="d8">d8</option>
									<option value="d10">d10</option>
									<option value="d12">d12</option>
									<option value="d20">d20</option>
								</select>
								<span> +</span>
								<input type="number" name="attr_gmod_dmg_mod" value="0" />
							</span>
						</div>
						<div class="flex-row flex-left">
							<input class="enable-mod" type="checkbox" name="attr_arm_on" value="1" />
							<span>
								<span class="label" data-i18n="armor-modifier:">Armor Modifier: +</span>
								<input type="number" name="attr_gmod_arm_mod" value="0" />
							</span>
						</div>
					</div>
				</div>
				<input type="hidden" name="attr_calc_ongoing" value="0" />
				<input type="hidden" name="attr_calc_dmg" value="0" />
				<input type="hidden" name="attr_calc_arm" value="0" />
			</fieldset>
		</div>
	</div>
</div> -->

<div class="lower-container">
	<div class="moves-container">
		<div class="mid-header moves-header">
			<span class="label" data-i18n="moves-u">MOVES</span>
		</div>
		<div class="mid-content moves">
			<fieldset class="repeating_moves">
				<div class="move-main">
					<button type="roll" name="roll_move" value="&{template:move} {{charname=@{character_name}}} {{movename=@{movename_base}}} {{trigger=@{movetrigger}}} {{success=@{movesuccess}}} {{partial=@{movepartial}}} {{miss=@{movemiss}}} {{doroll=[[@{move_doroll}]]}} {{result=[[@{rolltype} + @{movestat} +@{movemod} + (@{rollforward})[forward] + @{global_ongoing}[ongoing global]]]}} {{details=@{movedetails}}}">
					<span class="rolltext" name="attr_move_name" value="@{move_name}"></span>
					</button>
					<input class="expander expand-move" type="checkbox" name="attr_expand_move" value="1" title="Details" checked="checked"  />
					<span> </span>
					<div class="move-expansion">
						<span class="label" data-i18n="move-name">Move Name:</span>
						<input type="text" name="attr_movename_base" value="" />
						<span class="label" data-i18n="move-trigger">Trigger:</span>
						<br>
						<textarea type="text" name="attr_movetrigger"></textarea>
						<br>
						<input class="enable-roll" type="checkbox" name="attr_move_doroll" value="1" checked="checked" />
						<span class="label" data-i18n="move-roll">Roll:</span>
							<select class="moveroll" name="attr_movestat">
								<option value="0[no stat]" selected="selected">--</option>
								<option value="@{light_mod}[light]" data-i18n="light-u">LIGHT</option>
								<option value="@{dark_mod}[dark]" data-i18n="dark-u">DARK</option>
								<option value="@{mastery_mod}[mastery]" data-i18n="mastery-u">MASTERY</option>
								<option value="@{heart_mod}[heart]" data-i18n="heart-u">HEART</option>
								<option value="@{statmod_query}" data-i18n="ask-u">ASK</option>
								<option value="@{link_query}" data-i18n="bond-u">LINK</option>
							</select>
							<span class="label moveroll"> + </span>
							<input class="moveroll" type="number" name="attr_movemod" value="0" />
						<div class="rollresults-container">
							<span class="label" data-i18n="move-success">Success (10+):</span>
							<br>
							<textarea type="text" name="attr_movesuccess"></textarea>
							<span class="label" data-i18n="move-partial">At a Cost (7-9):</span>
							<br>
							<textarea type="text" name="attr_movepartial"></textarea>
							<span class="label" data-i18n="move-miss">Miss (6-):</span>
							<br>
							<textarea type="text" name="attr_movemiss"></textarea>
						</div>
						<span class="label" data-i18n="move-details">Details:</span>
						<br />
						<textarea class="move-details" name="attr_movedetails"></textarea>
					</div>
				</div>
			</fieldset>
		</div>
	</div>
</div>

</div>

<div class="page sub-page">

<div class="mid-container sub-container">
	<input type="checkbox" class="invisible gear-priority" name="attr_subsection_priority" value="1" />
	<div class="gear-container">
		<input type="hidden" name="attr_calc_load" value="0" />
		<div class="mid-header coin-header">
			<span class="label" data-i18n="coin-u">COIN</span>
			<span class="coin-counter">
				<input type="number" class="bigger-number" name="attr_coin" value="0" />
			</span>
		</div>
		<div class="mid-header gear-header">
			<span class="label" data-i18n="gear-u">GEAR</span>
			<span class="weight-counter">
				<span class="label" data-i18n="load-u">LOAD</span>
				<input type="number" title="Current Load" class="load-count" name="attr_load" value="@{calc_load}" disabled="true" /> <span class="label">/</span>
				<input type="number" title="Maximum Load" class="load-count" name="attr_load_max" value="0" />
			</span>
		</div>
		<div class="mid-content gear">
			<fieldset class="repeating_gear">
				<div class="gear-main">
					<button type="roll" name="roll_gear" value="&{template:dwgeneral} {{charname=@{character_name}}} {{infoname=@{gearname_base}}} {{tags=@{gear_tags}}} {{details=@{geardetails}}} {{doroll=[[@{gear_doroll}]]}} {{result=[[@{damagedie} + @{gear_damage} + @{global_dmg}]]}}">
					<span class="rolltext" name="attr_gear_name" value="@{gear_name}"></span>
					</button>
					<input type="hidden" name="attr_comp_gear_type" value="Item">
					<input type="hidden" name="attr_calc_gear_dmg" value="0">
					<input type="hidden" name="attr_calc_gear_armor" value="0">
					<input type="hidden" name="attr_calc_gear_armormod" value="0">
					<input type="hidden" name="attr_calc_gear_weight" value="0">
					<input type="hidden" name="attr_gear_doroll" value="0">
					<input class="expander expand-gear" type="checkbox" name="attr_expand_gear" value="1" title="Details" checked="checked"  />
					<span> </span>
					<div class="gear-expansion">
						<span class="label" data-i18n="gear-name">Gear Name:</span>
						<input type="text" name="attr_gearname_base" value="" />
						<span class="label" data-i18n="gear-tags">Gear Tags:</span>
						<input type="text" name="attr_gear_tags" value="" />
						<div class="flex-row">
							<span>
								<span class="label" data-i18n="value:">Value:</span><input type="number" name="attr_gear_value" value="0" />
							</span>
							<span>
								<span class="label" data-i18n="qty:">Qty:</span><input type="number" name="attr_gear_quantity" value="1" />
							</span>
							<span>
								<span class="label" data-i18n="weight:">Weight:</span><input type="number" name="attr_gear_weight" \>
							</span>
						</div>
						<div class="toggler flex-right">
							<label>
								<input type="checkbox" name="attr_gear_equipped" value="1" />
								<span class="label" data-i18n="equipped">Equipped</span>
							</label>
						</div>
						<br>
						<div class="toggler gear-level-selector">
							<label>
								<input type="radio" class="gear-type-option" name="attr_gear_type" value="Item" checked="checked"><span data-i18n="item">Item</span>
							</label>
							<label>
								<input type="radio" class="gear-type-option" name="attr_gear_type" value="Weapon"><span data-i18n="weapon">Weapon</span>
							</label>
							<label>
								<input type="radio" class="gear-type-option" name="attr_gear_type" value="Armor"><span data-i18n="armor">Armor</span>
							</label>
						</div>
						<input type="radio" class="gear-item-expander invisible" name="attr_calc_gear_type" value="Item" checked="checked">
						<input type="radio" class="gear-weapon-expander invisible" name="attr_calc_gear_type" value="Weapon">
						<input type="radio" class="gear-armor-expander invisible" name="attr_calc_gear_type" value="Armor">
						<div class="flex-row flex-right gear-item">
							
						</div>
						<div class="flex-row flex-right gear-weapon">
							<span>
								<span class="label" data-i18n="damage:">Damage:</span><input type="number" name="attr_gear_damage" value="0" />
							</span>
						</div>
						<div class="flex-row flex-right gear-armor">
							<span>
								<span class="label" data-i18n="base-armor:">Base Armor:</span><input type="number" name="attr_gear_base_armor" value="0" />
							</span>
							<span>
								<span class="label" data-i18n="+armor:">+ Armor:</span><input type="number" name="attr_gear_add_armor" value="0" />
							</span>
						</div>
						<br />
						<span class="label" data-i18n="gear-details">Details:</span>
						<br />
						<textarea class="gear-details" name="attr_geardetails"></textarea>
					</div>
				</div>
			</fieldset>
		</div>
	</div>

	<div class="spells-container">
		<div class="mid-header spells-header">
			<span class="label" data-i18n="spells-u">SPELLS</span>
			<span class="prepared-counter"><span class="label" data-i18n="spell-levels-prepared:">Spell Levels Prepared: </span><span class="label" name="attr_levels_prepared">0</span></span>
					</div>
		<div class="mid-content spells">
			<fieldset class="repeating_spells">
				<div class="spell-main compendium-drop-target">
					<button type="roll" name="roll_spell" value="&{template:spell} {{charname=@{character_name}}} {{spellname=@{spellname_base}}} {{doroll=[[@{spell_doroll}]]}} {{tags=@{spell_tags}}} {{result=[[@{spell_diecount}@{spell_die} + @{spellmod}]]}} {{level=[[@{spell_level}]]}} {{details=@{spelldetails}}}">
					<span class="rolltext" name="attr_spell_name" value="@{spell_name}"></span>
					</button>
					<input type="hidden" name="attr_comp_spell_level" value="-1">
					<input type="hidden" name="attr_level0_type" value="^{rote}">
					<input type="hidden" name="attr_comp_fullroll" value="0">
					<input class="expander expand-spell" type="checkbox" name="attr_expand_spell" value="1" title="Details" checked="checked"  />
					<span> </span>
					<div class="spell-expansion">
						<span class="label" data-i18n="spell-name">Spell Name:</span>
						<input type="text" name="attr_spellname_base" value="" />
						<span class="label" data-i18n="spell-tags">Spell Tags:</span>
						<input type="text" name="attr_spell_tags" value="" />
						<span class="label" data-i18n="spell-level">Level:</span>
						<div class="toggler spell-level-selector">
							<label>
								<input type="radio" class="spell-level-option" name="attr_spell_level" value="0" checked="checked"><span name="attr_level0_type" data-i18n-dynamic></span>
							</label>
							<label>
								<input type="radio" class="spell-level-option" name="attr_spell_level" value="1"><span data-i18n="1st">1st</span>
							</label>
							<label>
								<input type="radio" class="spell-level-option" name="attr_spell_level" value="3"><span data-i18n="3rd">3rd</span>
							</label>
							<label>
								<input type="radio" class="spell-level-option" name="attr_spell_level" value="5"><span data-i18n="5th">5th</span>
							</label>
							<label>
								<input type="radio" class="spell-level-option" name="attr_spell_level" value="7"><span data-i18n="7th">7th</span>
							</label>
							<label>
								<input type="radio" class="spell-level-option" name="attr_spell_level" value="9"><span data-i18n="9th">9th</span>
							</label>
						</div>
						<input type="checkbox" class="spell-level-rote invisible" tabindex="-1" name="attr_spell_level" value="0" checked="checked">
						<div class="toggler flex-right">
							<label>
							<input type="checkbox" name="attr_spell_prepared" value="1" />
							<span class="label" data-i18n="prepared">Prepared</span>
							</label>
						</div>
						<!-- <input type="number" class="spell-level" name="attr_spell_level" value="0" /><span></span> -->
						<input class="enable-roll" type="checkbox" name="attr_spell_doroll" value="1" />
						<span class="label" data-i18n="spell-roll">Roll:</span>
							<input class="spellroll" type="number" name="attr_spell_diecount" value="1" />
							<select class="spelldie" name="attr_spell_die">
								<option value="d4" selected="selected">d4</option>
								<option value="d6">d6</option>
								<option value="d8">d8</option>
								<option value="d10">d10</option>
								<option value="d12">d12</option>
								<option value="d20">d20</option>
							</select>
							<span class="label spellroll"> + </span>
							<input class="spellroll" type="number" name="attr_spellmod" value="0" />
						<span class="label" data-i18n="spell-details">Details:</span>
						<br />
						<textarea class="spell-details" name="attr_spelldetails"></textarea>


						<input type="hidden" name="attr_calc_prepval" value="0">
					</div>
				</div>
			</fieldset>
		</div>
	</div>

</div>
<div class="sheet-notesfield">
<span class="label" >Notes</span>
						<br />
						<textarea class="sheet-notes" name="attr_notes" ></textarea><textarea class="sheet-notes sheet-notes2" name="attr_notes2" ></textarea>
    </div>
</div>

<div class="page settings-page">

<div class="mid-container settings-container">

	<div class="mid-header">
		<span class="label" data-i18n="settings-u">SETTINGS</span>
	</div>
	<div class="settings-content">
		<div class="settings-content-box">
			<span class="label" data-i18n="sheet-layout"><h3>Sheet Layout</h3></span>
			<span class="label" data-i18n="sub-section-display-priority">Sub Section Display Priority</span>
			<div class="toggler">
				<label>
					<input type="radio" class="toggler-btn" name="attr_subsection_priority_base" value="0" checked="checked"><span data-i18n="spells">Spells</span>
				</label>
				<label>
					<input type="radio" class="toggler-btn" name="attr_subsection_priority_base" value="1"><span data-i18n="gear">Gear</span>
				</label>
			</div>
		</div>
		<div class="settings-content-box">
			<span class="label" data-i18n="compendium"><h3>Compendium</h3></span>
			<span class="label" data-i18n="add-moves-class-drop">Add moves on Class Drop:</span>
			<div class="toggler">
				<label>
					<input type="radio" class="toggler-btn" name="attr_populate_moves" value="all" checked="checked"><span data-i18n="all">All Moves</span>
				</label>
				<label>
					<input type="radio" class="toggler-btn" name="attr_populate_moves" value="classonly"><span data-i18n="class-only">Class Moves</span>
				</label>
				<label>
					<input type="radio" class="toggler-btn" name="attr_populate_moves" value="none"><span data-i18n="none">None</span>
				</label>
			</div>
		</div>
		<div class="settings-content-box">
			<span class="label" data-i18n="spellcasting"><h3>Spellcasting</h3></span>
			<span class="label" data-i18n="level-0-spell-type">Level 0 Spell Type</span>
			<div class="toggler">
				<label>
					<input type="radio" class="spelltype-rote" name="attr_level0_type_base" value="rote" checked="checked"><span data-i18n="rote">Rote</span>
				</label>
				<label>
					<input type="radio" class="spelltype-cantrip" name="attr_level0_type_base" value="cantrip"><span data-i18n="cantrip">Cantrip</span>
				</label>
			</div>
		</div>
	</div>

</div>
</div>

<!-- COMPENDIUM DROP CATCHERS -->
<input type="hidden" name="attr_drop_category" accept="Category">
<input type="hidden" name="attr_drop_name" accept="Name">
<input type="hidden" name="attr_drop_data" accept="data">
<input type="hidden" name="attr_drop_content" accept="Content">

</div>
<!-- End Container div -->

<input type="checkbox" class="tip-confirm-flag" name="attr_tip_confirm_flag" value="1">
<div class="class-tip">
	<button type="action" class="cancel-button" name="act_cancelclass">&#128473;</button>
	<h3><span data-i18n="getting-started">Getting Started</span></h3>
	<p><span data-i18n="getting-started-class-tip">Welcome to the Dungeon World Character Sheet by Roll20!  To get started, drag a class from the compendium or select one from the choices below:</span></p>
	<button type="action" name="act_bard" data-i18n="Bard">Bard</button>
	<button type="action" name="act_cleric" data-i18n="Cleric">Cleric</button>
	<button type="action" name="act_druid" data-i18n="Druid">Druid</button>
	<button type="action" name="act_fighter" data-i18n="Fighter">Fighter</button>
	<button type="action" name="act_paladin" data-i18n="Paladin">Paladin</button>
	<button type="action" name="act_ranger" data-i18n="Ranger">Ranger</button>
	<button type="action" name="act_thief" data-i18n="Thief">Thief</button>
	<button type="action" name="act_wizard" data-i18n="Wizard">Wizard</button>
</div>

<div class="compendium_warning">
	<span data-i18n="accepting-drop-u">ACCEPTING DROP FROM COMPENDIUM</span>
</div>

<rolltemplate class="sheet-rolltemplate-move">
<div class="rt-container">
	<div class="rt-header rt-header-minor">{{charname}} <span data-i18n="name-makes-move">makes a Move</span></div>
	<div class="rt-header">{{movename}}</div>
	<div class="rt-content">
		{{#trigger}}
		<div class="rt-row">
			<span class="label rt-label" data-i18n="move-trigger">Trigger:</span>
			<span class="rt-value rt-text">{{trigger}}</span>
		</div>
		{{/trigger}}
		{{#modifiers}}
		<div class="rt-row">
			<span class="label rt-label" data-i18n="move-modifiers">Modifier(s):</span>
			<span class="rt-value rt-text">{{modifiers}}</span>
		</div>
		{{/modifiers}}

		{{#rollGreater() doroll 0}}
		{{#result}}
			<div class="rt-row">
				<span class="label rt-label" data-i18n="move-roll">Roll:</span>
				<span class="rt-value rt-text">{{result}}</span>
			</div>
			{{#rollLess() result 7}}
			{{#miss}}
			<div class="rt-row">
				<span class="label rt-label" data-i18n="move-effect">Effect:</span>
				<span class="rt-value rt-text">{{miss}}</span>
			</div>
			{{/miss}}
			{{/rollLess() result 7}}

			{{#rollBetween() result 7 9}}
			{{#partial}}
			<div class="rt-row">
				<span class="label rt-label" data-i18n="move-effect">Effect:</span>
				<span class="rt-value rt-text">{{partial}}</span>
			</div>
			{{/partial}}
			{{/rollBetween() result 7 9}}

			{{#rollGreater() result 9}}
			{{#success}}
			<div class="rt-row">
				<span class="label rt-label" data-i18n="move-effect">Effect:</span>
				<span class="rt-value rt-text">{{success}}</span>
			</div>
			{{/success}}
			{{/rollGreater() result 9}}
		{{/result}}
		{{/rollGreater() doroll 0}}
		
		{{#details}}
		<div class="rt-row">
			<span class="label rt-label" data-i18n="move-details">Details:</span>
			<span class="rt-value rt-text">{{details}}</span>
		</div>
		{{/details}}

	</div>


</div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-spell">
<div class="rt-container">
	<div class="rt-header rt-header-minor">{{charname}} <span data-i18n="name-makes-spell">casts a spell</span></div>
	<div class="rt-header">{{spellname}}</div>
	{{#rollTotal() level 0}}
	<div class="rt-header rt-header-minor"><span class="rt-text" data-i18n="rote">Rote</div>
	{{/rollTotal() level 0}}
	{{#rollGreater() level 0}}
	<div class="rt-header rt-header-minor"><span class="rt-text" data-i18n="level:">Level: </span>{{level}}</div>
	{{/rollGreater() level 0}}
	{{#tags}}
	<div class="rt-header rt-header-minor"><span class="rt-text">{{tags}}</span></div>
	{{/tags}}
	<div class="rt-content">
		{{#modifiers}}
		<div class="rt-row">
			<span class="label rt-label" data-i18n="spell-modifiers">Modifier(s):</span>
			<span class="rt-value rt-text">{{modifiers}}</span>
		</div>
		{{/modifiers}}

		{{#rollGreater() doroll 0}}
		{{#result}}
			<div class="rt-row">
				<span class="label rt-label" data-i18n="spell-roll">Roll:</span>
				<span class="rt-value rt-text">{{result}}</span>
			</div>
		{{/result}}
		{{/rollGreater() doroll 0}}

		{{#details}}
		<div class="rt-row">
			<span class="label rt-label" data-i18n="spell-details">Details:</span>
			<span class="rt-value rt-text">{{details}}</span>
		</div>
		{{/details}}

	</div>


</div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-dwgeneral">
<div class="rt-container">
	{{#rollname}}
	<div class="rt-header rt-header-minor">{{charname}} <span data-i18n="rolls">rolls</span> {{rollname}}</div>
	{{/rollname}}
	{{#infoname}}
	<div class="rt-header rt-header-minor">{{charname}} <span data-i18n="displays">displays</span> {{infoname}}</div>
	{{/infoname}}
	{{#tags}}
	<div class="rt-header rt-header-minor"><em>{{tags}}</em></div>
	{{/tags}}
	<div class="rt-content">
		{{#doroll}}
			{{#rollGreater() doroll 0}}
			{{#result}}
			<div class="rt-row">
				<span class="label rt-label" data-i18n="move-roll">Roll:</span>
				<span class="rt-value rt-text">{{result}}</span>
			</div>
			{{/result}}
			{{/rollGreater() doroll 0}}
		{{/doroll}}
		{{^doroll}}
			{{#result}}
			<div class="rt-row">
				<span class="label rt-label" data-i18n="move-roll">Roll:</span>
				<span class="rt-value rt-text">{{result}}</span>
			</div>
			{{/result}}
		{{/doroll}}
		{{#details}}
		<div class="rt-row">
			<span class="rt-value rt-text">{{details}}</span>
		</div>
		{{/details}}
	</div>


</div>
</rolltemplate>

<script type="text/worker">

// Storing the data for moves right in the sheet, as js object.
var dwMoves = {
	deepDive: {
		class: "Basic",
		fullname: "Deep Dive",
		trigger: "When you confront the situation in front of you and ask questions",
		roll: "HEART",
		success: "Ask 3",
		partial: "Ask 1",
		miss: "The GM tells you something you wish wasn't true",
		details: "• What here could I use to ____?\n• What here is not as it seems?\n• What is the best way out of this situation?\n• What is the biggest threat here?\n• What was done here recently?\nYou gain +1 Forward to acting on the answers."
	},
	convinceSomebody: {
		class: "Basic",
		fullname: "Convince Somebody",
		trigger: "When you tell someone what you want from them and are trying to get them to do it",
		roll: "DARK",
		success: "NPC: They'll do it, until something puts them in danger or reveals your true intentions.\n PC: both",
		partial: "NPC: They’ll do it, but need some clear assurance or evidence first.\nPC: Choose one:\n",
		miss: "Prepare for the worst.",
		details: "PC: • If they do it, they mark experience. \n• If they refuse, they lose a Link."
	},
	makeALink: {
		class: "Basic",
		fullname: "Make a Link",
		trigger: "When you meet someone for the first time, or make an emotional breakthrough with someone you already know, you form a connection with a character, or Make a Link. Roll based on the kind of relationship. Dark Links are rivals, Light Links are friends, Heart Links is introspection, and Mastery Links are students and teachers. \nWhen you roll a link that is based off your highest stat, gain +1 on the roll. When you roll for your lowest stat, Mark Experience.",
		roll: "ASK",
		success: "You both get a Link on one another, and your Link Move triggers.",
		partial: "Your Link move doesn’t trigger, or the Link isn’t what you intended.",
		miss: "your Link Move doesn’t trigger, The GM gives you a Link, but also picks one:\n• Make a Move as hard as you want\n• Someone else gets a Link"
	},
	limitBreak: {
		class: "Basic",
		fullname: "Limit Break",
		trigger: "When you help out your friends or create an oppurtunity for them.",
		roll: "LIGHT",
		success: "You give +1 Forward to an ally.",
		partial: "It costs you.\n• Spend a Link\n• Take Harm",
		miss: "Make things worse."
	},
	castMagic: {
		class: "Basic",
		fullname: "Cast Magic",
		trigger: "When you use magic in any meaningful way.",
		roll: "MASTERY",
		success: "Describe your magic and pick 3:",
		partial: "Same as a sucess, but pick 1.",
		details: "\n• The Magic opens something.\n• The Magic causes 1 Harm.\n• The Magic heals 1 Harm.\n• The Magic hits more then one entity.\n• The Magic has no unintended consquences.\n• The Magic creates an illusion.\n• The Magic inflicts a semi-permanent condition.\n• The Magic bypasses defenses."
	},
	strikeWithIntent: {
		class: "Basic",
		fullname: "Strike with Intent",
		trigger: "When you move to cause Harm against another",
		roll: "DARK",
		success: "Deal Harm, and choose two.",
		partial: "Deal harm and choose one.",
		miss: "You take harm, and the GM makes a move.",
		details: "\n• Defend yourself from Harm\n• Deal Great Harm (+1 Harm)\n• Take Control of the situation"
	},
	strikeToSubdue: {
		class: "Basic",
		fullname: "Strike to Subdue",
		trigger: "When you try to fight another without causing harm.",
		roll: "MASTERY",
		success: "Deal Harm, and choose two.",
		partial: "Deal harm and choose one.",
		miss: "You take harm, and the the situation escalates.",
		details:"\n• Take Something From Them\n• Force a Change of Location\n• De-escalate the Situation"
	},
	defendFromHarm: {
		class: "Basic",
		fullname: "Defy Danger (Int)",
		trigger: "When you try to prevent or avoid danger or Harm from happening to either yourself or others.",
		roll: "LIGHT",
		success: "You prevent or avoid the danger.",
		partial: "It costs you: expose yourself to danger or the GM makes a Move.",
		miss: "They take harm anyway and the situation escalates."
	},
	pushThroughStress: {
		class: "Basic",
		fullname: "Push Through Stress",
		trigger: "When you act despite an imminent threat or suffer a calamity, and deal with it through mental fortitude",
		roll: "ASK",
		success: "Pick two:.",
		partial: "Pick one:",
		details: "• Succeed at what you were attempting\n• Take +1 Forward\n• Ask a question about this scene\n• Gain an advantageous position"
	},
	interfere: {
		class: "Basic",
		fullname: "Interfere",
		trigger: "When you try to stop someone else’s action by using suprise or force, roll with Dark.",
		roll: "DARK",
		success: "NPC: They don't do it.\nPC: Choose 2:\n• They are Pushing Through Stress to do it\n• They take experience if they don’t do it",
		partial: "NPC: They don't do it cleanly; something goes wrong in a dramatic way.\nPC:Choose one.",
		miss: "\nThey do it, and the GM makes a move as hard as they want. Good luck!",
		details: "• They are Pushing Through Stress to do it\n• They take experience if they don’t do it"
	},
	defend: {
		class: "Basic",
		fullname: "Defend",
		trigger: "When you stand in defense of a person, item, or location under attack",
		roll: "MASTERY",
		success: "Hold 3",
		partial: "Hold 1",
		miss: "No Hold",
		details: "So long as you stand in defense, when you or the thing you defend is attacked you may spend hold, 1 for 1, to choose an option:\n• Halve the attack's effect or damage\n• Open up the attacker to an ally, giving that ally +1 forward against the attacker\n• Deal damage to the attacker equal to your level"
	},
	discernrealities: {
		class: "Basic",
		fullname: "Discern Realities",
		trigger: "When you closely study a situation or person",
		roll: "WIS",
		success: "Ask the GM three questions from the list below.",
		partial: "Ask the GM one question from the list below.",
		miss: "You cannot discern any answers.",
		details: "Take +1 forward when acting on the answers:\n• What happened here recently?\n• What is about to happen?\n• What should I be on the lookout for?\n• What here is useful or valuable to me?\n• Who's really in control here?\n• What here is not what it appears to be?"
	},
	spoutlore: {
		class: "Basic",
		fullname: "Spout Lore",
		trigger: "When you consult your accumulated knowledge about something",
		roll: "HEART",
		success: "The GM will tell you something interesting and useful about the subject relevant to your situation.",
		partial: "The GM will only tell you something interesting - it's on you to make it useful.",
		details: "The GM might ask you \"How do you know this?\" Tell them the truth, now."
	},
	aidorinterfere: {
		class: "Basic",
		fullname: "Aid or Interfere",
		trigger: "When you help or hinder someone you have a Bond with",
		roll: "Link",
		success: "They take +1 or -2; your choice.",
		partial: "They take +1 or -2; your choice.  You also expose yourself to danger, retribution, or cost."
	},
	lastbreath: {
		class: "Basic",
		fullname: "Last Breath",
		trigger: "When you're dying you catch a glimpse of what lies beyond the Black Gates of Death's Kingdom (the GM will describe it)",
		roll: "--",
		success: "You've cheated death - you're in a bad spot but you're still alive.",
		partial: "Death will offer you a bargain.  Take it and stabilize or refuse and pass beyond the Black Gates into whatever fate awaits you.",
		miss: "Your fate is sealed. You're marked as Death's own and you'll cross the threshold soon. The GM will tell you when."
	},

}

// ---- Start worker scripts ----- //


on("sheet:opened", function() {
	getAttrs(["character_class", "isNPC"], function(v) {
		if (v.isNPC != "1") {
			update = {};
			if (v.character_class == null || v.character_class == "") {
				update["tip_confirm_flag"] = "0";
			} else {
				update["tip_confirm_flag"] = "1";
			}
			setAttrs(update);
		}
	});
});

on("clicked:bard", function(eventinfo) {
	setupClass("Bard");
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("clicked:cleric", function(eventinfo) {
	setupClass("Cleric");
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("clicked:druid", function(eventinfo) {
	setupClass("Druid");
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("clicked:fighter", function(eventinfo) {
	setupClass("Fighter");
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("clicked:paladin", function(eventinfo) {
	setupClass("Paladin");
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("clicked:ranger", function(eventinfo) {
	setupClass("Ranger");
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("clicked:thief", function(eventinfo) {
	setupClass("Thief");
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("clicked:wizard", function(eventinfo) {
	setupClass("Wizard");
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("clicked:cancelclass", function(eventinfo) {
	setAttrs({tip_confirm_flag: 1}, "silent");
});

on("change:light change:debil_weak", function() {
	getAttrs(["light", "debil_weak"], function(values) {
		setAttrs({
			calc_light_mod: calculateMod(values.light) - values.debil_weak
		});
	});
});

on("change:dark change:debil_shaky", function() {
	getAttrs(["dark", "debil_shaky"], function(values) {
		setAttrs({
			calc_dark_mod: calculateMod(values.dark) - values.debil_shaky
		});
	});
});

on("change:mastery change:debil_sick", function() {
	getAttrs(["mastery", "debil_sick"], function(values) {
		setAttrs({
			calc_mastery_mod: calculateMod(values.mastery) - values.debil_sick
		});
	});
});

on("change:heart change:debil_stunned", function() {
	getAttrs(["heart", "debil_stunned"], function(values) {
		setAttrs({
			calc_heart_mod: calculateMod(values.heart) - values.debil_stunned
		});
	});
});

on("change:wisdom change:debil_confused", function() {
	getAttrs(["wisdom", "debil_confused"], function(values) {
		setAttrs({
			calc_wisdom_mod: calculateMod(values.wisdom) - values.debil_confused
		});
	});
});

on("change:charisma change:debil_scarred", function() {
	getAttrs(["charisma", "debil_scarred"], function(values) {
		setAttrs({
			calc_charisma_mod: calculateMod(values.charisma) - values.debil_scarred
		});
	});
});

on("change:page", function() {
	getAttrs(["page"], function(v) {
		setAttrs({calc_page:v.page});
	});
});

on("change:isNPC", function () {
	getAttrs(["isNPC", "character_class"], function(v) {
		if (v.isNPC == "1") {
			setAttrs({calc_isNPC: v.isNPC, tip_confirm_flag: 1});
		} else {
			if (v.character_class == null || v.character_class == "") {
				setAttrs({calc_isNPC: v.isNPC, tip_confirm_flag: 0});
			} else {
				setAttrs({calc_isNPC: v.isNPC, tip_confirm_flag: 1});
			}
		}
	});
})


var calculateMod = function(attribute) {

return attribute;
	<!-- if (attribute < 4) -->
		<!-- return -3; -->
	<!-- if (attribute < 6)  -->
		<!-- return -2; -->
	<!-- if (attribute < 9) -->
		<!-- return -1; -->
	<!-- if (attribute < 13) -->
		<!-- return 0; -->
	<!-- if (attribute < 16) -->
		<!-- return 1; -->
	<!-- if (attribute < 18) -->
		<!-- return 2; -->
	<!-- if (attribute >= 18) -->
		<!-- return 3; -->
	<!-- return 0; -->
	
};

var statnameToFreeform = function(statname) {
	if (statname == "--") {
		return "0[no stat]";
	}
	if (statname == "LIGHT") {
		return "@{light_mod}[light]";
	}
	if (statname == "DARK") {
		return "@{dark_mod}[dark]";
	}
	if (statname == "MASTERY") {
		return "@{mastery_mod}[mastery]";
	}
	if (statname == "HEART") {
		return "@{heart_mod}[heart]";
	}
	if (statname == "WIS") {
		return "@{wisdom_mod}[wisdom]";
	}
	if (statname == "CHA") {
		return "@{charisma_mod}[charisma]";
	}
	if (statname == "ASK") {
		return "@{statmod_query}"
	}
	return "0[no stat]";
}

// Spell is the name of the compendium page to get.
var addSpell = function(spell, rowid = 0) {
	var newspellid = rowid;
	if (!rowid) {
		newspellid = generateRowID();
	}
	console.log("Adding Spell: " + spell);
	getCompendiumPage(spell, function(page) {
		console.log("Got compendium page for " + spell);
		if (page["data"]) {
			var data = page["data"];
			console.log("dropping " + spell);
			console.log(data);
			var prefix = "repeating_spells_" + newspellid + "_";
			var attrs = {};
			attrs[prefix + "spellname_base"] = page["name"];
			attrs[prefix + "spell_tags"] = data["Tags"] || "";
			attrs[prefix + "comp_spell_level"] = data["Level"] || "0";
			attrs[prefix + "comp_fullroll"] = data["Roll"] || "";
			attrs[prefix + "spelldetails"] = data["Details"] || "";

			// Don't auto-expand gear from compendium.
			attrs[prefix + "expand_spell"] = 0;
			setAttrs(attrs);
		}
	});
}

// Gear is the Name of the Compendium Page to get.
var addGear = function(gear, rowid = 0) {
	var newgearid = rowid;
	if (!rowid) {
		newgearid = generateRowID();
	}
	console.log("Adding Gear: " + gear);
	getCompendiumPage(gear, function(page) {
		console.log("Got compendium page for " + gear);
		if (page["data"]) {
			var data = page["data"];
			var prefix = "repeating_gear_" + newgearid + "_";
			var attrs = {};
			attrs[prefix + "gearname_base"] = page["name"];
			attrs[prefix + "gear_tags"] = data["Tags"] || "";
			attrs[prefix + "gear_value"] = data["Value"] || "0";
			attrs[prefix + "gear_type"] = data["Type"] || "Item";
			attrs[prefix + "gear_weight"] = data["Weight"] || "0";
			attrs[prefix + "gear_damage"] = data["Damage"] || "0";
			attrs[prefix + "gear_base_armor"] = data["Armor"] || "0";
			attrs[prefix + "gear_add_armor"] = data["Armor Mod"] || "0";
			attrs[prefix + "geardetails"] = data["Details"] || "";

			// Don't auto-expand gear from compendium.
			attrs[prefix + "expand_gear"] = 0;
			setAttrs(attrs);
		}
	});
}

// move is the shortname, no special chars, spaces, all lowercase.
var addMove = function(move, rowid = 0) {
	if (dwMoves[move]) {
		var newmoveid = rowid;
		if (!rowid) {
			newmoveid = generateRowID();
		}
		var prefix = "repeating_moves_" + newmoveid + "_";
		var attrs = {};
		attrs[prefix + "movename_base"] = dwMoves[move].fullname;
		if (dwMoves[move].trigger) attrs[prefix + "movetrigger"] = dwMoves[move].trigger;
		if (dwMoves[move].roll && dwMoves[move].roll != "NONE") {
			if (dwMoves[move].roll) attrs[prefix + "movestat"] = statnameToFreeform(dwMoves[move].roll);
			if (dwMoves[move].success) attrs[prefix + "movesuccess"] = dwMoves[move].success;
			if (dwMoves[move].partial) attrs[prefix + "movepartial"] = dwMoves[move].partial;
			if (dwMoves[move].miss) attrs[prefix + "movemiss"] = dwMoves[move].miss;
			attrs[prefix + "move_doroll"] = 1;
		} else if (!dwMoves[move].roll || dwMoves[move].roll == "NONE") {
			attrs[prefix + "move_doroll"] = 0;
		}

		if (dwMoves[move].details) attrs[prefix + "movedetails"] = dwMoves[move].details;

		// Don't need the move expanded if it was auto added.
		if (rowid == 0)	{
			attrs[prefix + "expand_move"] = 0;
		}

		setAttrs(attrs);
	}
}

var addBasicMoves = function() {
	addMove("deepDive");
	addMove("convinceSomebody");
	addMove("makeALink");
	addMove("limitBreak");
	addMove("interfere");
	addMove("castMagic");
	addMove("strikeWithIntent");
	addMove("strikeToSubdue");
	addMove("defendFromHarm");
	addMove("pushThroughStress");
}

var addClassMoves = function() {

}

var parseRoll = function(rollText) { 
	var rollPieces = [];
	rollPieces = rollText.split("d");
	rollPieces[1] = "d" + rollPieces[1];
	return rollPieces;
}

var shortName = function(fullName) {
	var shortened = fullName.toLowerCase();

	shortened = shortened.replace(/\W/g, '');
	return shortened;
}


on("change:repeating_moves:movename_base", function() {
   getAttrs(["repeating_moves_movename_base"], function(values) {
	  setAttrs({
		 repeating_moves_move_name: values.repeating_moves_movename_base
	  });
   });
});

on("change:repeating_spells:spellname_base", function() {
   getAttrs(["repeating_spells_spellname_base"], function(v) {
	  setAttrs({
		 repeating_spells_spell_name: v.repeating_spells_spellname_base
	  });
   });
});

on("change:repeating_spells", function(eventInfo) {
	getAttrs(["level0_type_base"], function(v) {
		if (eventInfo.sourceAttribute.split("_").length > 3) {
			setAttrs({
				repeating_spells_level0_type: v.level0_type_base
			}, "silent");

		}

		getSectionIDs("repeating_spells", function(ids) {
			var preparedLevels = [];
			for(var i=0; i < ids.length; i++) {
				var attr = "repeating_spells_" + ids[i] + "_calc_prepval";
				preparedLevels.push(attr);
			}

			var newLevelsPrepared = 0;
			getAttrs(preparedLevels, function(v) {
				_.each(v, function(prepval, attrName) {
					newLevelsPrepared = newLevelsPrepared + Number(prepval);
				});

				setAttrs({
					levels_prepared: newLevelsPrepared
				});
			});
		});
	});
});


on("change:repeating_spells:spell_prepared", function() {
	getAttrs(["repeating_spells_spell_prepared","repeating_spells_spell_level"], function(v) {
		if (v.repeating_spells_spell_prepared > 0) {
			setAttrs({repeating_spells_calc_prepval: v.repeating_spells_spell_level});
		} else {
			setAttrs({repeating_spells_calc_prepval: 0})
		}
	});
});



on("change:repeating_spells:spell_level", function() {
	getAttrs(["repeating_spells_spell_prepared", "repeating_spells_spell_level"], function(v) {
		if (v.repeating_spells_spell_prepared > 0 && v.repeating_spells_spell_level == 0) {
			setAttrs({repeating_spells_spell_prepared: 0});
		}
		if (v.repeating_spells_spell_prepared > 0) {
			setAttrs({repeating_spells_calc_prepval: v.repeating_spells_spell_level});
		}
	});
});

on("change:repeating_spells:comp_spell_level", function() {
	getAttrs(["repeating_spells_comp_spell_level", "repeating_spells_comp_fullroll"], function(v) {
		if (v.repeating_spells_comp_spell_level >= 0) {
			setAttrs({
				repeating_spells_spell_level:v.repeating_spells_comp_spell_level,
				repeating_spells_comp_spell_level: -1
			});
			if (v.repeating_spells_comp_fullroll != "" && v.repeating_spells_comp_fullroll != null && v.repeating_spells_comp_fullroll != "") {
				var rollPieces = [];
				rollPieces = parseRoll(v.repeating_spells_comp_fullroll);
				setAttrs({
					repeating_spells_spell_diecount: rollPieces[0],
					repeating_spells_spell_die: rollPieces[1],
					repeating_spells_spell_doroll: 1
				});
			} else {
				setAttrs({repeating_spells_spell_doroll: 0});
			}
		}
	});
});

/*
on("remove:repeating_spells", function(eventinfo) {
	if (eventinfo.removedInfo[eventinfo['sourceAttribute']+'_spell_prepared'] > 0) {
		getAttrs(["levels_prepared"], function(v) {
			var finalPreparedSpells = v.levels_prepared - 1;
			setAttrs({levels_prepared: finalPreparedSpells});
		});
	}
});
*/

on("change:repeating_gear:gearname_base", function() {
   getAttrs(["repeating_gear_gearname_base"], function(values) {
	  setAttrs({
		 repeating_gear_gear_name: values.repeating_gear_gearname_base
	  });
   });
});

on("change:repeating_gear:comp_gear_type", function() {
	getAttrs(["repeating_gear_comp_gear_type"], function(v) {
		setAttrs({repeating_gear_gear_type: v.repeating_gear_comp_gear_type});
	});
});

on("change:repeating_gear:gear_type", function() {
	getAttrs(["repeating_gear_gear_type"], function(v) {
		setAttrs({repeating_gear_calc_gear_type: v.repeating_gear_gear_type});
		if (v.repeating_gear_gear_type == "Weapon") {
			setAttrs({repeating_gear_gear_doroll: 1});
		} else {
			setAttrs({repeating_gear_gear_doroll: 0});
		}
	});
});

on("change:repeating_gear:gear_weight change:repeating_gear:gear_quantity", function() {
	getAttrs(["repeating_gear_gear_weight", "repeating_gear_gear_quantity"], function(v) {
		var weight = v.repeating_gear_gear_weight;
		var quantity = v.repeating_gear_gear_quantity;
		if (isNaN(weight)) weight = 0;
		if (isNaN(quantity)) quantity = 0;
		setAttrs({
			repeating_gear_calc_gear_weight: +weight * +quantity
		});
	})
})

on("change:repeating_gear:calc_gear_weight remove:repeating_gear", function() {
	getSectionIDs("repeating_gear", function(ids) {
		var gearWeights = [];
		for(var i=0; i < ids.length; i++) {
			gearWeights.push("repeating_gear_" + ids[i] + "_calc_gear_weight");
		}
		getAttrs(gearWeights, function(v) {
			var newLoad = 0;
			_.each(v, function(weight, attrName) {
				newLoad = newLoad + Number(weight);
			});

			setAttrs({
				calc_load: newLoad
			});
		});
	});
});


on("change:repeating_moves:move_doroll", function() {
	getAttrs(["repeating_moves_move_doroll", "repeating_moves_movestat"], function(v) {
		if (v.repeating_moves_move_doroll != "1" && v.repeating_moves_movestat == "@{statmod_query}")
			setAttrs({repeating_moves_movestat: 0});
	});
});

on("change:level0_type_base", function() {
	getAttrs(["level0_type_base"], function(v) {
		getSectionIDs("repeating_spells", function(ids) {
			for(var i=0; i < ids.length; i++) {
				var newRowAttr = {};
				newRowAttr["repeating_spells_" + ids[i] + "_level0_type"] = v.level0_type_base;
				setAttrs(newRowAttr);
			}
		});
	});
});

on("change:subsection_priority_base", function() {
	getAttrs(["subsection_priority_base"], function(v) {
		setAttrs({subsection_priority: v.subsection_priority_base});
	});
});

// --- Equipment Mods Calcs --- //
// Set Mods within each repitem

on("change:repeating_gear:gear_equipped change:repeating_gear:gear_type change:repeating_gear:gear_base_armor change:repeating_gear:gear_add_armor change:repeating_gear:gear_damage", function() {
	getAttrs(["repeating_gear_gear_equipped", "repeating_gear_gear_type", "repeating_gear_gear_base_armor", "repeating_gear_gear_add_armor", "repeating_gear_gear_damage"], function(v) {
		if (v.repeating_gear_gear_type == "Armor" && v.repeating_gear_gear_equipped > 0) {
			var armor = v.repeating_gear_gear_base_armor;
			if (armor === undefined || armor == "") armor = 0;
			setAttrs({repeating_gear_calc_gear_armor: armor});
		} else {
			setAttrs({repeating_gear_calc_gear_armor: 0});
		}

		if (v.repeating_gear_gear_type == "Armor" && v.repeating_gear_gear_equipped > 0) {
			var armormod = v.repeating_gear_gear_add_armor;
			if (armormod === undefined || armormod == "") armormod = 0;
			setAttrs({repeating_gear_calc_gear_armormod: armormod});
		} else {
			setAttrs({repeating_gear_calc_gear_armormod: 0});
		}

		if (v.repeating_gear_gear_type == "Weapon" && v.repeating_gear_gear_equipped > 0) {
			var damage = v.repeating_gear_gear_damage;
			if (damage === undefined || damage == "") damage = 0;
			setAttrs({repeating_gear_calc_gear_dmg: damage});
		} else {
			setAttrs({repeating_gear_calc_gear_dmg: 0});
		}
	});
});


// Set equipment mods from all sections whenever one changes
on("change:repeating_gear", function(eventInfo) {
	getSectionIDs("repeating_gear", function(ids) {
		var dmgMods = [];
		for(var i=0; i < ids.length; i++) {
			var attr = "repeating_gear_" + ids[i] + "_calc_gear_dmg";
			dmgMods.push(attr);
		}
		var armMods = [];
		for(var i=0; i < ids.length; i++) {
			var attr = "repeating_gear_" + ids[i] + "_calc_gear_armormod";
			armMods.push(attr);
		}
		var armorVals = [];
		for(var i=0; i < ids.length; i++) {
			var attr = "repeating_gear_" + ids[i] + "_calc_gear_armor";
			armorVals.push(attr);
		}

		getAttrs(armMods, function(v) {
			var newGearArmorMod = "0";
			_.each(v, function(val, attrName) {
				newGearArmorMod = newGearArmorMod.concat("+").concat("(" + val + ")");
			});

			newGearArmorMod = "(" + newGearArmorMod + ")";
			newGearArmorMod = newGearArmorMod.replace(/\+\(0\)/g, "");

			console.log("Setting armormod to: " + newGearArmorMod)
			setAttrs({
				equipment_armormod: newGearArmorMod
			});
		});

		getAttrs(dmgMods, function(v) {
			var newGearDmg = "0";
			_.each(v, function(val, attrName) {
				if (+val > newGearDmg) newGearDmg = val;
			});

			newGearDmg = "(" + newGearDmg + ")[Equipped Weapon]";

			setAttrs({
				equipment_dmg: newGearDmg
			});
		});

		getAttrs(armorVals, function(v) {
			var newGearArmor = "0";
			_.each(v, function(val, attrName) {
				if (+val > newGearArmor) newGearArmor = val;
			});

			newGearArmor = "(" + newGearArmor + ")";

			setAttrs({
				equipment_armor: newGearArmor
			});
		});
	});

});


// -------------------- //
//   Global Mods Calcs  //
// -------------------- //
// Set Ongoing
on("change:repeating_gmods:enable_modifier change:repeating_gmods:ongoing_on change:repeating_gmods:gmod_ongoing_mod", function() {
	getAttrs(["repeating_gmods_enable_modifier", "repeating_gmods_ongoing_on", "repeating_gmods_gmod_ongoing_mod"], function(v) {
		if (v.repeating_gmods_ongoing_on > 0 && v.repeating_gmods_enable_modifier > 0) {
			var mod = v.repeating_gmods_gmod_ongoing_mod;
			if (mod === undefined || mod == "") mod = 0;
			setAttrs({repeating_gmods_calc_ongoing: mod});
		} else {
			setAttrs({repeating_gmods_calc_ongoing: 0});
		}

		if (!v.repeating_gmods_enable_modifier > 0) {
			setAttrs({repeating_gmods_calc_ongoing: 0});
		}
	});
});

// Set 1d6+1d8 (barbarian dice)     
on("change:repeating_gmods:enable_modifier change:repeating_gmods:barbdice_on change:repeating_gmods:gmod_rolltype", function() {
	getAttrs(["repeating_gmods_enable_modifier", "repeating_gmods_barbdice_on", "repeating_gmods_gmod_rolltype", "rolltype"], function(v) {
		if (v.repeating_gmods_barbdice_on > 0 && v.repeating_gmods_enable_modifier > 0) {
			var rolltype = "1d6+1d8";
			if (rolltype === undefined || rolltype == "") mod = "2d6";
			setAttrs({rolltype: rolltype});
		} else {
			setAttrs({rolltype: "2d6"});
		}

		if (!v.repeating_gmods_enable_modifier > 0) {
			setAttrs({rolltype: "2d6"});
		}
	});
});


// Set Damage Mod
on("change:repeating_gmods:enable_modifier change:repeating_gmods:dmg_on change:repeating_gmods:gmod_dmg_diecount change:repeating_gmods:gmod_dmg_die change:repeating_gmods:gmod_dmg_mod", function() {
	getAttrs(["repeating_gmods_enable_modifier", "repeating_gmods_dmg_on", "repeating_gmods_gmod_dmg_diecount", "repeating_gmods_gmod_dmg_die", "repeating_gmods_gmod_dmg_mod"], function(v) {
		if (v.repeating_gmods_dmg_on > 0 && v.repeating_gmods_enable_modifier > 0) {
			var dieCount = v.repeating_gmods_gmod_dmg_diecount;
			var dmgMod = v.repeating_gmods_gmod_dmg_mod;
			var dmgDie = v.repeating_gmods_gmod_dmg_die;
			if (dieCount === undefined || dieCount == "") dieCount = 0;
			if (Number(dieCount) == 0) dmgDie = 0;
			if (dmgMod === undefined || dmgMod == "") dmgMod = 0;
			if (Number(dieCount) < 0) {
				dmgRoll = "0".concat(dieCount).concat(dmgDie).concat("+").concat(dmgMod);
			} else {
				dmgRoll = "".concat(dieCount).concat(dmgDie).concat("+").concat(dmgMod);
			}
			setAttrs({repeating_gmods_calc_dmg: dmgRoll});
		}
		else {
			setAttrs({repeating_gmods_calc_dmg: 0});
		}

		if (!v.repeating_gmods_enable_modifier > 0) {
			setAttrs({repeating_gmods_calc_dmg: 0});
		}
	});
});

// Set Armor Mod

on("change:repeating_gmods:enable_modifier change:repeating_gmods:arm_on change:repeating_gmods:gmod_arm_mod", function() {
	getAttrs(["repeating_gmods_enable_modifier", "repeating_gmods_arm_on", "repeating_gmods_gmod_arm_mod"], function(v) {
		if (v.repeating_gmods_arm_on > 0 && v.repeating_gmods_enable_modifier > 0) {
			var mod = v.repeating_gmods_gmod_arm_mod;
			if (mod === undefined || mod == "") mod = 0;
			setAttrs({repeating_gmods_calc_arm: mod});
		} else {
			setAttrs({repeating_gmods_calc_arm: 0});
		}

		if (!v.repeating_gmods_enable_modifier > 0) {
			setAttrs({repeating_gmods_calc_arm: 0});
		}
	});
});


// Set global mods from all sections whenever one changes
on("change:repeating_gmods", function(eventInfo) {
	getSectionIDs("repeating_gmods", function(ids) {
		var ongoingMods = [];
		for(var i=0; i < ids.length; i++) {
			var attr = "repeating_gmods_" + ids[i] + "_calc_ongoing";
			ongoingMods.push(attr);
		}
		var dmgMods = [];
		for(var i=0; i < ids.length; i++) {
			var attr = "repeating_gmods_" + ids[i] + "_calc_dmg";
			dmgMods.push(attr);
		}
		var armMods = [];
		for(var i=0; i < ids.length; i++) {
			var attr = "repeating_gmods_" + ids[i] + "_calc_arm";
			armMods.push(attr);
		}

		getAttrs(ongoingMods, function(v) {
			var newGlobOngoing = "0";
			_.each(v, function(val, attrName) {
				newGlobOngoing = newGlobOngoing.concat("+").concat("(" + val + ")");
			});

			newGlobOngoing = "(" + newGlobOngoing + ")";
			newGlobOngoing = newGlobOngoing.replace(/\+\(0\)/g, "");

			setAttrs({
				global_ongoing: newGlobOngoing
			});
		});

		getAttrs(dmgMods, function(v) {
			var newGlobDmg = "0";
			_.each(v, function(val, attrName) {
				newGlobDmg = newGlobDmg.concat("+").concat("(" + val + ")");
			});

			newGlobDmg = "(" + newGlobDmg + ")";
			newGlobDmg = newGlobDmg.replace(/\+\(0\)/g, "");

			setAttrs({
				global_dmg: newGlobDmg
			});
		});

		getAttrs(armMods, function(v) {
			var newGlobArm = "0";
			_.each(v, function(val, attrName) {
				newGlobArm = newGlobArm.concat("+").concat("(" + val + ")");
			});

			newGlobArm = "(" + newGlobArm + ")";
			newGlobArm = newGlobArm.replace(/\+\(0\)/g, "");

			setAttrs({
				global_arm: newGlobArm
			});
		});
	});

});

on("change:repeating_bonds", function(eventInfo) {
	getSectionIDs("repeating_bonds", function(ids) {
	    if (ids.length == 0){
	        setAttrs({
	            bond_query: "(0)[Other Bond]"
	        });
	        return;
	    }
	    
	    var attrs = [];
	    for(var i=0; i < ids.length; i++) {
	        var attr = "repeating_bonds_" + ids[i] + "_bond_simple";
			attrs.push(attr);
	    }
	    console.log(ids);
	    
	    getAttrs(attrs, function(v) {
	        var bonds = {};
	        _.each(v, function(val, attrName) {
	            if (val in bonds){
	                bonds[val] += 1;
	            }else{
	                bonds[val] = 1;
	            }
	        });
	        
	        var query = "?{Bond";
	        _.each(bonds, function(count, name) {
	            query = query.concat(`|${name}, (${count})[Bonds with ${name}]`);
	        });
	        query = query.concat("|Other, (0)[Other Bond]}");
	        
	        setAttrs({
	            bond_query: query
	        });
	    });
	});
});

// ---------------------- //
// -- Compendium Drops -- //
// ---------------------- //

on("change:drop_category", function(eventinfo) {
	if(eventinfo.newValue === "Monsters") {
		// Handle query for changing to an NPC if not already one.
		getAttrs(["isNPC", "drop_name"], function(v) {
			if (v.isNPC) {
				setAttrs({character_name: v.drop_name});
			}
		});
	}
	else {
		handle_drop(eventinfo.newValue);
	}
});

var handle_drop = function(category, eventinfo) {
	console.log("Handling drop");
	console.log(category);
	setAttrs({drop_category: ""}, "silent", function() {
		getAttrs(["drop_name", "drop_data", "drop_content"], function(v) {
			pagedata = {};
			try {
				pagedata = JSON.parse(v.drop_data);
			} catch(e) {
				pagedata = v.drop_data;
			}
			console.log(pagedata);
			if (category === "Moves") {
				addMove(pagedata["data-Shortname"]);
			} else if (category === "Equipment") {
				addGear(v.drop_name);
			} else if (category === "Spells") {
				addSpell(v.drop_name);
			} else if (category === "Classes") {
				var update = {};
				update["comp_name"] = v.drop_name;
				update["comp_damagedie"] = pagedata["Base Damage"];
				update["comp_classmoves"] = pagedata["data-Basic Moves"];
				update["comp_load"] = pagedata["Load"];
				setAttrs(update);
				//setAttrs({comp_name: "dropped"}, "silent");
			}
		});
	});
}
// Move Drop
on("change:repeating_moves:comp_shortname", function(eventInfo) {
	
});

// NPC Drop
on("change:comp_NPC_moves", function() {
	getAttrs(["comp_NPC_moves"], function(v) {
		var attrs = {};
		movesList = JSON.parse(v.comp_NPC_moves);
		for (i = 0; i < movesList.length; i++) {
			var newid = generateRowID();
			attrs["repeating_NPCmoves_" + newid + "_NPC_move"] = movesList[i];
		}

		setAttrs(attrs);
	});
});

// ------------------------------------------ //
// -- Main Class Drop Compilation Function -- //
// ------------------------------------------ //

on("change:comp_name", function() {
	getAttrs(["populate_moves", "comp_name", "comp_damagedie", "comp_classmoves", "comp_load", "light_mod"], function(v) {
		if (v.comp_name != "dropped") {
		
			// Populate all basic moves.
			if (v.populate_moves == "all") {
				addBasicMoves();
				setAttrs({
					populate_moves: "classonly"
				});
			}

			// Populate the Class's starting moves
			if (v.populate_moves == "all" || v.populate_moves == "classonly") {
				var startingMoves = []
				startingMoves = JSON.parse(v.comp_classmoves);

				for (var i = 0, len = startingMoves.length; i < len; i++) {
					addMove(shortName(startingMoves[i]));
				}

				setAttrs({
					damagedie: v.comp_damagedie
				});
			}
			setAttrs({character_class: v.comp_name});
		}
	});
	setAttrs({comp_name: "dropped", tip_confirm_flag: 1}, "silent");
});

// Classname is the name of the Compendium Page.
var setupClass = function(classname) {
/*
	getCompendiumPage(classname, function(page) {
		if (page["data"]) {
			var update = {};
			var data = page["data"];
			update["character_class"] = classname;
			update["comp_name"] = classname;
			update["comp_damagedie"] = data["Base Damage"];
			update["comp_classmoves"] = data["data-Basic Moves"];
			update["comp_load"] = data["Load"];
			setAttrs(update);
		}
	});*/
	var update = {};
	update["character_class"] = classname;
	addBasicMoves();
	setAttrs(update);
};

</script>